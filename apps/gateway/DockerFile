# ─────────────────────────────────────────────
# Build
# ─────────────────────────────────────────────
FROM node:20-alpine AS build

WORKDIR /app

# deps first for caching
COPY package*.json ./
RUN npm ci --omit=dev

COPY . .

# ─────────────────────────────────────────────
# Runtime
# ─────────────────────────────────────────────
FROM node:20-alpine

WORKDIR /app

# runtime deps
RUN apk add --no-cache tini

# non-root user
RUN addgroup -S app && adduser -S app -G app
USER app

ENV NODE_ENV=production
ENV PORT=3000

COPY --from=build /app /app

EXPOSE 3000

# health probe for orchestrators
HEALTHCHECK --interval=10s --timeout=3s --retries=3 \
  CMD wget -q -O - http://localhost:3000/health || exit 1

ENTRYPOINT ["/sbin/tini", "--"]
CMD ["node", "src/app.js"]
